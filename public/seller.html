<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ecom Market - Seller Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="seller_styles.css">
</head>
<body>
  <div class="seller-dashboard">
    <header class="dashboard-header">
      <div class="header-content">
        <h1>Seller Dashboard</h1>
        <div class="dashboard-controls">
          <button id="addProductBtn" class="btn btn-primary">Add Product</button>
          <button onclick="logout()" class="btn btn-secondary">Logout</button>
        </div>
      </div>
    </header>

    <div class="dashboard-content">
      <div class="filters">
        <input type="text" id="searchInput" placeholder="Search products..." class="search-input">
        <select id="categoryFilter" class="filter-select">
          <option value="">All Categories</option>
        </select>
        <select id="stockFilter" class="filter-select">
          <option value="">All Stock Levels</option>
          <option value="out">Out of Stock</option>
          <option value="low">Low Stock (â‰¤10)</option>
          <option value="in">In Stock (>10)</option>
        </select>
      </div>

      <div id="productsContainer" class="product-grid"></div>
    </div>

    <div id="productModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add New Product</h2>
          <button type="button" class="close-modal" id="closeModalBtn">&times;</button>
        </div>

        <form id="productForm" class="product-form">
          <input type="hidden" id="productId">
          
          <div class="form-grid">
            <div class="form-group">
              <label for="productName">Product Name *</label>
              <input type="text" id="productName" required>
            </div>

            <div class="form-group">
              <label for="productPrice">Price (â‚¹) *</label>
              <input type="number" id="productPrice" min="0" step="0.01" required>
            </div>

            <div class="form-group">
              <label for="productCategory">Category *</label>
              <input type="text" id="productCategory" required list="categoryList">
              <datalist id="categoryList"></datalist>
            </div>

            <div class="form-group">
              <label for="productBrand">Brand *</label>
              <input type="text" id="productBrand" required>
            </div>

            <div class="form-group">
              <label for="productStock">Stock *</label>
              <input type="number" id="productStock" min="0" required>
            </div>

            <div class="form-group form-full-width">
              <label for="productDescription">Description *</label>
              <textarea id="productDescription" rows="3" required></textarea>
            </div>

            <div class="form-group form-full-width">
              <label>Product Images (Max 5) *</label>
              <div class="image-upload-container" id="imageUpload">
                <input type="file" id="productImages" multiple accept="image/*" style="display: none;">
                <div class="upload-placeholder">
                  <span class="upload-icon">ðŸ“·</span>
                  <p>Click to upload images or drag and drop</p>
                  <p class="upload-hint">Supported formats: JPG, PNG, JPEG. Max size: 5MB each</p>
                </div>
              </div>
              <div id="imagePreview" class="image-preview-container"></div>
            </div>

            <div class="form-group form-full-width">
              <button type="submit" class="btn btn-primary submit-btn">Add Product</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const userId = localStorage.getItem('userId');
    let allProducts = [];
    let filteredProducts = [];
    let categories = new Set();

    // Check login status
    if (!userId) {
      window.location.href = 'index.html';
    }

    function logout() {
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      window.location.href = 'index.html';
    }

    // Modal handling
    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const productForm = document.getElementById('productForm');
    const submitBtn = productForm.querySelector('button[type="submit"]');
    let isEditing = false;

    document.getElementById('addProductBtn').addEventListener('click', () => {
      isEditing = false;
      modalTitle.textContent = 'Add New Product';
      submitBtn.textContent = 'Add Product';
      productForm.reset();
      document.getElementById('imagePreview').innerHTML = '';
      productModal.style.display = 'flex';
    });

    document.getElementById('closeModalBtn').addEventListener('click', () => {
      productModal.style.display = 'none';
    });

    productModal.addEventListener('click', (e) => {
      if (e.target === productModal) productModal.style.display = 'none';
    });

    // Image upload functionality
    const imageUpload = document.getElementById('imageUpload');
    const imageInput = document.getElementById('productImages');
    const imagePreview = document.getElementById('imagePreview');
    let selectedImages = [];

    // Prevent default drag and drop behavior for the upload area
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      imageUpload.addEventListener(eventName, preventDefaults, false);
    });

    // Add visual feedback when dragging files over the upload area
    ['dragenter', 'dragover'].forEach(eventName => {
      imageUpload.addEventListener(eventName, () => {
        imageUpload.classList.add('highlight');
      });
    });

    // Remove visual feedback when dragging leaves or files are dropped
    ['dragleave', 'drop'].forEach(eventName => {
      imageUpload.addEventListener(eventName, () => {
        imageUpload.classList.remove('highlight');
      });
    });

    // Handle both drag-and-drop and click-to-upload functionality
    imageUpload.addEventListener('drop', handleDrop);
    imageUpload.addEventListener('click', () => imageInput.click());

    // Process dropped files
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }

    // Handle file selection (both from drop and file input)
    function handleFiles(files) {
      files = [...files];
      // Limit to maximum 5 images
      if (files.length > 5) {
        alert('Maximum 5 images allowed');
        return;
      }

      // Validate file types and sizes
      const validFiles = files.filter(file => {
        const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
        const maxSize = 5 * 1024 * 1024; // 5MB limit per file

        if (!validTypes.includes(file.type)) {
          alert(`Invalid file type: ${file.name}`);
          return false;
        }

        if (file.size > maxSize) {
          alert(`File too large: ${file.name}`);
          return false;
        }

        return true;
      });

      selectedImages = validFiles;
      updateImagePreviews();
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function updateImagePreviews() {
      imagePreview.innerHTML = '';
      selectedImages.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.createElement('div');
          preview.className = 'image-preview';
          preview.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <div class="image-preview-controls">
              ${index === 0 ? '<span class="cover-badge">Cover</span>' : ''}
              <button type="button" class="remove-image" onclick="removeImage(${index})">Ã—</button>
            </div>
          `;
          imagePreview.appendChild(preview);
        };
        reader.readAsDataURL(file);
      });
    }

    function removeImage(index) {
      selectedImages.splice(index, 1);
      updateImagePreviews();
    }

    // Form submission handler
    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        // Create FormData object to handle file uploads and form data
        const formData = new FormData();
        const productId = document.getElementById('productId').value;
        
        // Gather all product details from the form
        const productData = {
          name: document.getElementById('productName').value,
          price: document.getElementById('productPrice').value,
          category: document.getElementById('productCategory').value,
          brand: document.getElementById('productBrand').value,
          stock: document.getElementById('productStock').value,
          description: document.getElementById('productDescription').value,
          sellerId: userId // Include the seller's ID with the product data
        };

        // Add all product fields to the FormData object
        Object.entries(productData).forEach(([key, value]) => {
          formData.append(key, value);
        });

        // Handle image uploads - append each image to FormData
        if (selectedImages.length > 0) {
          selectedImages.forEach((file, index) => {
            formData.append('images', file);
            formData.append('isCover', index === 0); // First image is set as cover
          });
        }

        // Determine if we're creating a new product or updating existing one
        const url = isEditing ? `/api/products/${productId}` : '/api/products';
        const response = await fetch(url, {
          method: isEditing ? 'PUT' : 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to save product');
        }

        const result = await response.json();
        alert(`Product ${isEditing ? 'updated' : 'added'} successfully!`);
        productModal.style.display = 'none';
        productForm.reset();
        selectedImages = [];
        document.getElementById('imagePreview').innerHTML = '';
        await fetchProducts();
      } catch (error) {
        console.error('Error:', error);
        alert(`Failed to ${isEditing ? 'update' : 'add'} product: ${error.message}`);
      }
    });

    // Product management functions
    async function fetchProducts() {
      try {
        // Fetch all products belonging to the current seller
        const response = await fetch(`/api/products/seller/${userId}`);
        if (!response.ok) throw new Error('Failed to fetch products');

        // Update the global products array and category list
        allProducts = await response.json();
        categories = new Set(allProducts.map(p => p.category));
        updateCategoryFilter();
        filterProducts();
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to load products');
      }
    }

    // Update the category datalist with unique categories
    function updateCategoryFilter() {
      const select = document.getElementById('categoryList');
      select.innerHTML = Array.from(categories)
        .map(c => `<option value="${c}">${c}</option>`)
        .join('');
    }

    function filterProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;

      // Get the current stock filter value from the dropdown
      const stockFilter = document.getElementById('stockFilter').value;

      // Filter the products based on search, category, and stock criteria
      filteredProducts = allProducts.filter(product => {
        // Check if product name or description matches the search term (case insensitive)
        const matchesSearch = !searchTerm || 
          product.name.toLowerCase().includes(searchTerm) ||
          product.description.toLowerCase().includes(searchTerm);
        
        // Check if product matches the selected category filter
        const matchesCategory = !categoryFilter || product.category === categoryFilter;
        
        // Check if product matches the stock level filter:
        // - 'out': products with 0 stock
        // - 'low': products with 1-10 items
        // - 'in': products with more than 10 items
        const matchesStock = !stockFilter ||
          (stockFilter === 'out' && product.stock === 0) ||
          (stockFilter === 'low' && product.stock > 0 && product.stock <= 10) ||
          (stockFilter === 'in' && product.stock > 10);

        // Product must match all active filters to be included
        return matchesSearch && matchesCategory && matchesStock;
      });

      // Display the filtered products in the UI
      displayProducts(filteredProducts);
    }

    // Function to render the products in the container
    function displayProducts(products) {
      const container = document.getElementById('productsContainer');
      
      // Show a "No products found" message if the filtered list is empty
      if (products.length === 0) {
        container.innerHTML = '<div class="no-products">No products found</div>';
        return;
      }

      container.innerHTML = products.map(product => {
        const coverImage = product.images.find(img => img.isCover) || product.images[0];
        const stockStatus = product.stock > 10 ? 'In Stock' :
                          product.stock > 0 ? `Only ${product.stock} left` : 'Out of Stock';
        const stockClass = product.stock > 10 ? 'badge-success' :
                         product.stock > 0 ? 'badge-warning' : 'badge-error';

        return `
          <div class="product-card">
            <div class="product-actions">
              <button onclick="editProduct('${product._id}')" class="edit-btn">Edit</button>
              <button onclick="deleteProduct('${product._id}')" class="delete-btn">Delete</button>
            </div>
            <img src="${coverImage.path}" alt="${product.name}" class="product-image">
            <div class="product-info">
              <h3 class="product-title">${product.name}</h3>
              <p class="product-description">${product.description}</p>
              <div class="product-meta">
                <div class="price">â‚¹${product.price.toLocaleString()}</div>
                <span class="badge ${stockClass}">${stockStatus}</span>
                <div class="stock-quantity">Stock: ${product.stock} units</div>
              </div>
              <div class="product-footer">
                <span class="category">${product.category}</span>
                <span class="brand">${product.brand}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function editProduct(productId) {
      try {
        // Find the product to edit in the current products list
        const product = allProducts.find(p => p._id === productId);
        if (!product) throw new Error('Product not found');

        // Set up the modal for editing mode
        isEditing = true;
        modalTitle.textContent = 'Edit Product';
        submitBtn.textContent = 'Update Product';
        
        // Populate form fields with existing product data
        document.getElementById('productId').value = product._id;
        document.getElementById('productName').value = product.name;
        document.getElementById('productPrice').value = product.price;
        document.getElementById('productCategory').value = product.category;
        document.getElementById('productBrand').value = product.brand;
        document.getElementById('productStock').value = product.stock;
        document.getElementById('productDescription').value = product.description;

        // Reset and display existing product images
        selectedImages = [];
        document.getElementById('imagePreview').innerHTML = '';
        
        // Show existing product images with cover image indicator
        product.images.forEach(image => {
          const preview = document.createElement('div');
          preview.className = 'image-preview';
          preview.innerHTML = `
            <img src="${image.path}" alt="Existing image">
            <div class="image-preview-controls">
              ${image.isCover ? '<span class="cover-badge">Cover</span>' : ''}
            </div>
          `;
          imagePreview.appendChild(preview);
        });

        productModal.style.display = 'flex';
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to load product details');
      }
    }

    // Delete product with confirmation
    async function deleteProduct(productId) {
      // Show confirmation dialog before deletion
      if (!confirm('Are you sure you want to delete this product?')) {
        return;
      }

      try {
        const response = await fetch(`/api/products/${productId}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          throw new Error('Failed to delete product');
        }

        // Refresh the product list after successful deletion
        await fetchProducts();
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to delete product');
      }
    }

    // Event listeners for filtering
    document.getElementById('searchInput').addEventListener('input', filterProducts);
    document.getElementById('categoryFilter').addEventListener('change', filterProducts);
    document.getElementById('stockFilter').addEventListener('change', filterProducts);

    // Initialize
    fetchProducts();
  </script>
</body>
</html>